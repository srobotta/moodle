define("core_calendar/modal_event_form",["exports","jquery","core/custom_interaction_events","core/modal","core_form/events","./events","core/str","core/notification","core/fragment","core_calendar/repository"],(function(_exports,_jquery,CustomEvents,_modal,FormEvents,_events2,Str,Notification,Fragment,Repository){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),CustomEvents=_interopRequireWildcard(CustomEvents),_modal=_interopRequireDefault(_modal),FormEvents=_interopRequireWildcard(FormEvents),_events2=_interopRequireDefault(_events2),Str=_interopRequireWildcard(Str),Notification=_interopRequireWildcard(Notification),Fragment=_interopRequireWildcard(Fragment),Repository=_interopRequireWildcard(Repository);const SELECTORS={SAVE_BUTTON:'[data-action="save"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',START_DATE_FIELDS:'select[name^="timestart"]',END_DATE_FIELDS:'select[name^="timedurationuntil"]',START_DATE_DATE_PICKER:"#id_timestart_calendar",END_DATE_DATE_PICKER:"#id_timedurationuntil_calendar",DURATION_FIELD:"#id_timedurationminutes"};class ModalEventForm extends _modal.default{constructor(root){super(root),this.eventId=null,this.startTime=null,this.courseId=null,this.categoryId=null,this.contextId=null,this.reloadingBody=!1,this.reloadingTitle=!1,this.saveButton=this.getFooter().find(SELECTORS.SAVE_BUTTON),this.eventTimeDuration=0,this.lastUsedDatePickerId=null}configure(modalConfig){modalConfig.large=!0,super.configure(modalConfig)}setContextId(id){this.contextId=id}getContextId(){return this.contextId}setCourseId(id){this.courseId=id}getCourseId(){return this.courseId}setCategoryId(id){this.categoryId=id}getCategoryId(){return this.categoryId}hasCourseId(){return null!==this.courseId}hasCategoryId(){return null!==this.categoryId}setEventId(id){this.eventId=id}getEventId(){return this.eventId}hasEventId(){return null!==this.eventId}setStartTime(time){this.startTime=time}getStartTime(){return this.startTime}hasStartTime(){return null!==this.startTime}getForm(){return this.getBody().find("form")}disableButtons(){this.saveButton.prop("disabled",!0)}enableButtons(){this.saveButton.prop("disabled",!1)}getDateFromFields(selector){const identifier=selector.match(/"([^"]+)"/)[1],d=new Date;return d.setFullYear(document.getElementById("id_".concat(identifier,"_year")).value),d.setMonth(document.getElementById("id_".concat(identifier,"_month")).value-1),d.setDate(document.getElementById("id_".concat(identifier,"_day")).value),d.setHours(document.getElementById("id_".concat(identifier,"_hour")).value),d.setMinutes(document.getElementById("id_".concat(identifier,"_minute")).value),d}updateEndTime(){const startDate=this.getDateFromFields(SELECTORS.START_DATE_FIELDS),endDate=new Date(startDate.getTime()+this.eventTimeDuration),identifier=SELECTORS.END_DATE_FIELDS.match(/"([^"]+)"/)[1];document.getElementById("id_".concat(identifier,"_year")).value=endDate.getFullYear(),document.getElementById("id_".concat(identifier,"_month")).value=endDate.getMonth()+1,document.getElementById("id_".concat(identifier,"_day")).value=endDate.getDate(),document.getElementById("id_".concat(identifier,"_hour")).value=endDate.getHours(),document.getElementById("id_".concat(identifier,"_minute")).value=endDate.getMinutes()}calculateDuration(){const startDate=this.getDateFromFields(SELECTORS.START_DATE_FIELDS);return this.getDateFromFields(SELECTORS.END_DATE_FIELDS)-startDate}registerCalendarEvents(){var _M,_M$form,_M$form$dateselector;const calendar=null===(_M=M)||void 0===_M||null===(_M$form=_M.form)||void 0===_M$form||null===(_M$form$dateselector=_M$form.dateselector)||void 0===_M$form$dateselector?void 0:_M$form$dateselector.calendar;calendar&&calendar.on("dateClick",(()=>{this.lastUsedDatePickerId===SELECTORS.START_DATE_DATE_PICKER?this.updateEndTime():this.lastUsedDatePickerId===SELECTORS.END_DATE_DATE_PICKER&&(this.eventTimeDuration=this.calculateDuration())}),this)}reloadTitleContent(){return this.reloadingTitle||(this.reloadingTitle=!0,this.hasEventId()?this.titlePromise=Str.get_string("editevent","calendar"):this.titlePromise=Str.get_string("newevent","calendar"),this.titlePromise.then((string=>(this.setTitle(string),string))).catch(Notification.exception).always((()=>{this.reloadingTitle=!1}))),this.titlePromise}reloadBodyContent(formData){if(this.reloadingBody)return this.bodyPromise;this.reloadingBody=!0,this.disableButtons();const args={};return this.hasEventId()&&(args.eventid=this.getEventId()),this.hasStartTime()&&(args.starttime=this.getStartTime()),this.hasCourseId()&&(args.courseid=this.getCourseId()),this.hasCategoryId()&&(args.categoryid=this.getCategoryId()),void 0!==formData&&(args.formdata=formData),this.bodyPromise=Fragment.loadFragment("calendar","event_form",this.getContextId(),args),this.setBody(this.bodyPromise),this.bodyPromise.then((()=>{this.enableButtons(),this.eventTimeDuration=this.calculateDuration(),this.registerCalendarEvents()})).catch(Notification.exception).always((()=>{this.reloadingBody=!1})),this.bodyPromise}reloadAllContent(){return _jquery.default.when(this.reloadTitleContent(),this.reloadBodyContent())}show(){this.reloadAllContent(),super.show(this)}hide(){super.hide(this),this.setEventId(null),this.setStartTime(null),this.setCourseId(null),this.setCategoryId(null)}getFormData(){return this.getForm().serialize()}save(){const loadingContainer=this.saveButton.find(SELECTORS.LOADING_ICON_CONTAINER),invalid=this.getForm().find('[aria-invalid="true"]');if(invalid.length)return invalid.first().focus(),Promise.resolve();loadingContainer.removeClass("hidden"),this.disableButtons();const formData=this.getFormData();return Repository.submitCreateUpdateForm(formData).then((response=>{if(response.validationerror)this.reloadBodyContent(formData);else{const isExisting=this.hasEventId();this.hide(),isExisting?(0,_jquery.default)("body").trigger(_events2.default.updated,[response.event]):(0,_jquery.default)("body").trigger(_events2.default.created,[response.event])}})).catch(Notification.exception).always((()=>{loadingContainer.addClass("hidden"),this.enableButtons()}))}registerEventListeners(){super.registerEventListeners(this),this.getModal().on(CustomEvents.events.activate,SELECTORS.SAVE_BUTTON,((e,data)=>{this.getForm().submit(),data.originalEvent.preventDefault(),e.stopPropagation()})),this.getModal().on("submit",(e=>{FormEvents.notifyFormSubmittedByJavascript(this.getForm()[0]),this.save(),e.preventDefault(),e.stopPropagation()})),this.getModal().on("change",SELECTORS.START_DATE_FIELDS,(()=>{this.updateEndTime()})),this.getModal().on("change",SELECTORS.END_DATE_FIELDS,(()=>{this.eventTimeDuration=this.calculateDuration()})),this.getModal().on("click",SELECTORS.START_DATE_DATE_PICKER,(()=>{this.lastUsedDatePickerId=SELECTORS.START_DATE_DATE_PICKER})),this.getModal().on("click",SELECTORS.END_DATE_DATE_PICKER,(()=>{this.lastUsedDatePickerId=SELECTORS.END_DATE_DATE_PICKER})),this.getModal().on("focusout",SELECTORS.DURATION_FIELD,(e=>{const duration=parseInt(e.target.value);isNaN(duration)||(this.eventTimeDuration=60*duration*1e3,this.updateEndTime())}))}}return _exports.default=ModalEventForm,_defineProperty(ModalEventForm,"TYPE","core_calendar-modal_event_form"),_defineProperty(ModalEventForm,"TEMPLATE","calendar/modal_event_form"),ModalEventForm.registerModalType(),_exports.default}));

//# sourceMappingURL=modal_event_form.min.js.map